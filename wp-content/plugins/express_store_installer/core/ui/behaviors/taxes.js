/*
 * taxes.js - Tax rate settings behaviors
 */
function TaxRate(A){var g=jqnc(),u=ratesidx++,p=0,x=g("#tax-rates"),w='<select name="settings[taxrates]['+u+'][logic]"><option value="any">'+ANY_OPTION+'</option><option value="all">'+ALL_OPTION+"</option></select>",t='<th scope="row" valign="top"><p><input type="text" name="settings[taxrates]['+u+'][rate]" value="" size="6" class="selectall" /></p></th><td><div class="controls"></div><ul class="conditions"><li class="origin"><select name="settings[taxrates]['+u+'][country]" class="country"></select><select name="settings[taxrates]['+u+'][zone]" class="zone"></select></li><li class="scope"><p>'+APPLY_LOGIC.replace("%s",w)+":</p></li></ul></td>",j=g("<tr/>").html(t).appendTo(x),z=j.find("th p input"),s=j.find("div.controls"),l=j.find("td ul.conditions"),y=l.find("li.origin"),d=l.find("li.scope").hide(),e=l.find("select.country"),n=l.find("select.zone"),a=false,v=false,m=g('<label><input type="checkbox" name="settings[taxrates]['+u+'][localrates]" value="on" /> '+LOCAL_RATES+"</label>").appendTo(s),k='<button type="button" class="add"><img src="'+ECART_PLUGINURI+'/core/ui/icons/add.png" alt="+" width="16" height="16" /></button>',q='<button type="button" class="delete"><img src="'+ECART_PLUGINURI+'/core/ui/icons/delete.png" alt="-" width="16" height="16" /></button>',i=g(q).appendTo(s),B="";g.each(countries,function(D,C){B+='<option value="'+D+'">'+C+"</option>"});e.html(B).change(function(){var D=g(this);if(!v){v=D.val()}if(g.inArray(v,countriesInUse)!=-1){countriesInUse.splice(g.inArray(v,countriesInUse),1)}v=D.val();if(!zones[v]){countriesInUse.push(v)}n.hide().empty();if(zones[v]){var C=false;g.each(zones[g(e).val()],function(F,E){if(g.inArray(F,zonesInUse)!=-1){option=g("<option></option>").attr("disabled",true).val(F).html(E).appendTo(n)}else{option=g("<option></option>").val(F).html(E).appendTo(n)}if(C){C=false;option.attr("selected",true)}if(option.attr("selected")&&option.attr("disabled")){C=true}});if(C){allCountryZonesInUse.push(g(e).val());e.attr("selectedIndex",e.attr("selectedIndex")+1).change()}}if(n.children().length==0){n.hide()}else{n.show()}n.change()}).change();z.change(function(){this.value=asPercent(this.value,false,3,true)}).change();j.dequeue().hover(function(){s.show()},function(){s.fadeOut("fast")});i.click(function(){j.fadeOut("fast",function(){j.remove()})});m.change(function(){b((A.locals?A.locals:false))});new h(y);quickSelects();if(A){o(A)}function c(I,J){var D=p++,G='<li><select name="settings[taxrates]['+u+"][rules]["+D+'][p]" class="property"></select>&nbsp;<input type="text" name="settings[taxrates]['+u+"][rules]["+D+'][v]" size="25" class="value" /></li>',H=g(G),F=H.find("select.property"),E=H.find("input.value"),C="";g.each(RULE_LANG,function(L,K){C+='<option value="'+L+'">'+K+"</option>"});F.html(C);if(J){if(J.p){F.val(J.p)}if(J.v){E.val(J.v)}}F.change(function(){E.unbind("keydown").unbind("keypress").suggest(sugg_url+"&action=ecart_suggestions&t="+g(this).val(),{delay:500,minchars:2})}).change();new f(H);new h(H);if(I==y){d.show();H.appendTo(l);return}if(I){H.insertAfter(I)}else{H.appendTo(l)}}function b(H){var L,E,K,F,I,M,J,D='<div class="local-rates"><div class="label"><label>'+LOCAL_RATES+' <span class="counter"></span><input type="hidden" name="settings[taxrates]['+u+'][locals]" value="" /></label><button type="button" name="toggle" class="toggle">&nbsp;</button></div><div class="ui"><p>'+LOCAL_RATE_INSTRUCTIONS+'</p><ul></ul><button type="button" name="upload" class="button-secondary">Upload</button></div>',C=y.find("div.local-rates");if(!C.get(0)){C=g(D).appendTo(y)}else{C.toggle()}K=C.find("div.ui");L=C.find("div.label");toggle=L.find("button.toggle");L.unbind("click").click(function(){K.slideToggle("fast");toggle.trigger("toggle.clicked")});E=L.find("span.counter");F=K.find("p");I=K.find("ul");M=K.find("button");toggle.bind("toggle.clicked",function(){var R=g(this),P=20,N=180;function O(){J+=P;R.css("background-position",J+"px top");if(J<0){setTimeout(O,20)}else{R.css("background-position",null).removeClass("closed")}}function Q(){J-=P;R.css("background-position",J+"px top");if(Math.abs(J)<N){setTimeout(Q,20)}else{R.css("background-position",null).addClass("closed")}}if(J<0){return setTimeout(O,20)}else{return setTimeout(Q,20)}});n.change(function(){var N=false;if(localities[e.val()]&&localities[e.val()][g(this).val()]){N=localities[e.val()][g(this).val()]}G(N)});M.upload({name:"ecart",action:upload_url,params:{action:"ecart_upload_local_taxes"},onSubmit:function(){M.attr("disabled",true).addClass("updating").parent().css("width","100%")},onComplete:function(O){M.removeAttr("disabled").removeClass("updating");try{r=g.parseJSON(O);if(r.error){alert(r.error)}else{G(r)}}catch(N){alert(LOCAL_RATES_UPLOADERR)}}});if(H){K.hide();J=-180;toggle.addClass("closed");G(H)}function G(P){var N="",O=0;I.html("");E.html("");if(!P){return F.show()}else{F.hide()}g.each(P,function(R,S){var Q=R,T=S;if(P instanceof Array){Q=S;T=0}N+='<li><label><input type="text" name="settings[taxrates]['+u+"][locals]["+Q+']" size="6" value="'+T+'" /> '+Q+"</label></li>";O++});I.html(N).find("input").focus(function(){this.select()}).change(function(){this.value=asPercent(this.value,false,3,true);g(this).attr("title",asPercent(asNumber(this.value)+asNumber(z.val()),false,3,true))}).change();E.html("("+O+")")}}function f(D){var C=g(q).prependTo(D).click(function(){if(l.find("li").size()==3){d.hide()}D.fadeOut("fast",function(){D.remove()})});D.hover(function(){C.css("opacity",1)},function(){C.animate({opacity:0},"fast")})}function h(C){g(k).appendTo(C).click(function(){new c(C)})}function o(C){if(!C){return}if(C.rate){z.val(C.rate).change()}if(C.country){e.val(C.country).change()}if(C.zone){n.val(C.zone).change()}if(C.logic){d.find("select").val(C.logic).change()}if(C.localrates&&C.localrates=="on"){m.find("input").attr("checked",true).change()}if(C.rules){g.each(C.rules,function(E,D){new c(y,D)})}}}jQuery(document).ready(function(){var a=jqnc();if(!ratetable.get(0)){return}a("#add-taxrate").click(function(){new TaxRate()});ratetable.empty();if(rates){a(rates).each(function(){new TaxRate(this)})}else{new TaxRate()}});