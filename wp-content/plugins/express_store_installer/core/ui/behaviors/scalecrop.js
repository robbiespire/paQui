/*
 * scalecrop.js - Image scaling & cropping interface
 */
jQuery.fn.scaleCrop=function(v){var d=jqnc(),i={imgsrc:false,target:{width:300,height:300},init:{x:false,y:false,s:false}},v=d.extend(i,v),b=v.target.width+100,y=v.target.height+100,a=maskBottom=(y-v.target.height)/2,p=maskRight=(b-v.target.width)/2,l=v.target.width,e=v.target.height,r=maxHeight=aspect=0,m="px",t=" solid",u=m+t+" white",z=m+t+" black",w={x:0,y:0,s:100},f=d(this),h=f.parent().parent().parent().css({width:(b+22)+m}),s=d('<div class="scalecrop"/>').css({position:"relative",overflow:"hidden",width:b+m,height:y+m}).appendTo(f),n=d('<img src="'+v.imgsrc+'" />').appendTo(s),q=d("<div/>").css({width:v.target.width+m,height:v.target.height+m,border:(a+1)+u,opacity:0.8}).appendTo(s),k=d("<div/>").css({top:a+m,left:p+m,width:v.target.width+m,height:v.target.height+m,border:"1"+z}).appendTo(s),j=d("<div/>").appendTo(s),c=function(B){var I=((r-l)*B)+l,D=((maxHeight-e)*B)+e,G=(aspect<1)?D/maxHeight:I/r,H=k.position(),E=n.position(),A={width:n.width(),height:n.height()},C=x.data("draggable"),F=false;if(aspect<1){n.width(r*G).height(D)}else{n.width(I).height(maxHeight*G)}n[0].style.left=(n.position().left+Math.ceil((A.width-n.width())/2))+m;n[0].style.top=(n.position().top+Math.ceil((A.height-n.height())/2))+m;F=n.position();if(F.left>H.left){n[0].style.left=(H.left+1)+m;F=n.position()}if(F.top>H.top){n[0].style.top=(H.top+1)+m;F=n.position()}if(F.left+n.width()<H.left+k.width()+1){n[0].style.left=H.left+k.width()-n.width()+1+m;F=n.position()}if(F.top+n.height()<H.top+k.height()+1){n[0].style.top=H.top+k.height()-n.height()+1+m;F=n.position()}C.element.css({left:F.left,top:F.top});j.width((n.width()*2)-k.width()).height((n.height()*2)-k.height()).css({left:H.left+((k.width()-j.width())/2)+1+m,top:H.top+((k.height()-j.height())/2)+1+m});x.draggable("option","containment",j);w={x:F.left-H.left-1,y:F.top-H.top-1,s:G};f.trigger("change.scalecrop",[w])},o=function(){return w},x=d("<div/>").css({width:"100%",height:"100%",cursor:"move"}).draggable({helper:function(){return n.get(0)},start:function(B,A){A.position=A.offset},stop:function(C,B){var A=d(this).data("draggable");A.cancelHelperRemoval=true;A.element.css({left:B.position.left,top:B.position.top});w.x=n.position().left-k.position().left-1;w.y=n.position().top-k.position().top-1;f.trigger("change.scalecrop",[w])}}).appendTo(s),g=d('<div class="slidebar"/>').css({left:(b-176)/2+m}).appendTo(s);scaler=d('<div class="slideball"/>').unbind().mousedown(function(){scaler.css({backgroundPosition:"left -16px"});d(document).mouseup(function(){scaler.css({backgroundPosition:"left top"})})}).draggable({axis:"x",containment:"parent",drag:function(C,B){var A=g.width()-d(this).width(),D=B.position.left/A;c(D)}}).appendTo(g);n.hide().load(function(){r=this.width;maxHeight=this.height;aspect=r/maxHeight;x.width(r).height(maxHeight);var B=(v.init.x!==false)?v.init.x+m:k.position().left+((k.outerWidth()-n.width())/2)+m,A=(v.init.y!==false)?v.init.y+m:k.position().top+((k.outerHeight()-n.height())/2)+m,C=(v.init.s!==false)?v.init.s:0;c(C);inst=x.data("draggable");n.css({left:B,top:A}).fadeIn("fast");c(C);if(C!=0){scaler.get(0).style.left=(g.width()-scaler.width())*C+m}f.trigger("ready.scalecrop",[w])});return f};